<!DOCTYPE html>
<html translate="no">

<head>
	<title>Rom Patcher JS - Custom patcher template</title>
	<meta http-equiv="content-Type" content="text/html; charset=UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />



	<!-- Rom Patcher JS needed CSS/JS files -->
	<link type="text/css" rel="stylesheet" href="./rom-patcher-js/style.css" media="all" />
	<script type="text/javascript" src="./rom-patcher-js/RomPatcher.webapp.js"></script>

	<!-- Rom Patcher JS initialization -->
	<script type="text/javascript">
		window.addEventListener('load', function (evt) {
			try {
	RomPatcherWeb.initialize(
		{
			onloadrom: function (romFile) {
				const NES_HEADER_SIZE=16;
                const FDS_HEADER_SIZE=55;
				if (romFile.getExtension()==='nes' && (romFile.fileSize - NES_HEADER_SIZE) > 0){
                //console.log(romFile);
                    console.log(romFile.hashCRC32().toString(16));
                    romFile.seek(0);
	                var newFile = romFile.slice(16);
	                romFile.fileSize = newFile.fileSize;
	                romFile._u8array = newFile._u8array;
                    const crc32 = romFile.hashCRC32();
                    if (crc32===0xd445f698) {
                        RomPatcherWeb.pickEmbededFile('smb1-headerless.bps');
                    } else if (crc32===0x9a2db086) {
                        RomPatcherWeb.pickEmbededFile('smb1-pal-headerless.bps');
                    } else {RomPatcherWeb.setErrorMessage('Invalid NES rom');}
				} else if (romFile.getExtension()==='fds' && (romFile.fileSize - FDS_HEADER_SIZE) > 0) {
                    romFile.seek(0);
	                var newFile = romFile.slice(0x37);
	                romFile.fileSize = newFile.fileSize;
	                romFile._u8array = newFile._u8array;
                    var crc32 = romFile.hashCRC32();
                    if (crc32===0xf9a7b1be) {
                        RomPatcherWeb.pickEmbededFile('annsmb-headerless.bps');
                    } else {
                        romFile.seek(0x2167);
                        for (var i = 0; i < 9; i++) {
                            romFile.writeU8(0xFF);
                        }
                        crc32 = romFile.hashCRC32();
                        if (crc32===0x08167408) {
                            RomPatcherWeb.pickEmbededFile('smb2-headerless.bps');
                        }
                    }
                }
                console.log(romFile.hashCRC32().toString(16));
			}
		}, {
			file: 'patches.zip',
			patches: [
				{
					file: 'smb1-headerless.bps',
					outputName: 'smb1',
					outputExtension: 'nes',
                    optional: false
				},
				{
					file: 'smb1-pal-headerless.bps',
					outputName: 'smb1 pal',
					outputExtension: 'nes',
                    optional: false
				},
				{
					file: 'annsmb-headerless.bps',
					outputName: 'ann',
					outputExtension: 'fds',
                    optional: false
				},
				{
					file: 'smb2-headerless.bps',
					outputName: 'smb2',
					outputExtension: 'fds',
                    optional: false
				}
			]
		}
	);
			} catch (err) {
				var message = err.message;
				if (/incompatible browser/i.test(message) || /variable RomPatcherWeb/i.test(message))
					message = 'Your browser is outdated and it is not compatible with this app.';

				document.getElementById('rom-patcher-container').innerHTML = message;
				document.getElementById('rom-patcher-container').style.color = 'red';
			}
		});
	</script>
</head>

<body style="font: 15px 'Open Sans', sans-serif; background-color: #31343a; color: #e4e4e6;">
	<header style="text-align: center">
		<h1>Rom Patcher JS</h1>
		<p>
			This is a template that shows off Rom Patcher JS embeding capabilities. You can use this template to embed
			Rom Patcher JS in your website.<br />
			Take a look at the <a
				href="https://github.com/marcrobledo/RomPatcher.js/blob/master/custom_patcher_template.html"
				target="_blank">sourcecode</a> to see how it's done.
		</p>
	</header>


	<!-- Rom Patcher JS container -->
	<!--
		The following elements are required for Rom Patcher JS to work:
			#rom-patcher-input-file-rom
			#rom-patcher-select-patch
			#rom-patcher-button-apply
		The rest of elements are informative and can be removed, though it's recommended to keep them for a better user experience.
	-->
	<div id="rom-patcher-container">
		<div class="rom-patcher-row margin-bottom" id="rom-patcher-row-file-rom">
			<div class="text-right"><label for="rom-patcher-input-file-rom" data-localize="yes">ROM file:</label></div>
			<div class="rom-patcher-container-input">
				<input type="file" id="rom-patcher-input-file-rom" class="empty" disabled />
			</div>
		</div>
		<div class="margin-bottom text-selectable text-mono text-muted" id="rom-patcher-rom-info">
			<div class="rom-patcher-row">
				<div class="text-right">CRC32:</div>
				<div class="text-truncate"><span id="rom-patcher-span-crc32"></span></div>
			</div>
			<div class="rom-patcher-row">
				<div class="text-right">MD5:</div>
				<div class="text-truncate"><span id="rom-patcher-span-md5"></span></div>
			</div>
			<div class="rom-patcher-row">
				<div class="text-right">SHA-1:</div>
				<div class="text-truncate"><span id="rom-patcher-span-sha1"></span></div>
			</div>
			<div class="rom-patcher-row" id="rom-patcher-row-info-rom">
				<div class="text-right">ROM:</div>
				<div class="text-truncate"><span id="rom-patcher-span-rom-info"></span></div>
			</div>
		</div>

		<div class="rom-patcher-row margin-bottom" id="rom-patcher-row-file-patch">
			<div class="text-right"><label for="rom-patcher-input-file-patch" data-localize="yes">Patch file:</label>
			</div>
			<div class="rom-patcher-container-input">
				<select id="rom-patcher-select-patch"></select>
			</div>
		</div>
		<div class="rom-patcher-row margin-bottom" id="rom-patcher-row-patch-description">
			<div class="text-right text-mono text-muted" data-localize="yes">Description:</div>
			<div class="text-truncate" id="rom-patcher-patch-description"></div>
		</div>
		<div class="rom-patcher-row margin-bottom text-selectable text-mono text-muted"
			id="rom-patcher-row-patch-requirements">
			<div class="text-right text-mono" id="rom-patcher-patch-requirements-type">ROM requirements:</div>
			<div class="text-truncate" id="rom-patcher-patch-requirements-value"></div>
		</div>

		<div class="text-center" id="rom-patcher-row-apply">
			<div id="rom-patcher-row-error-message" class="margin-bottom"><span id="rom-patcher-error-message"></span>
			</div>
			<button id="rom-patcher-button-apply" data-localize="yes" disabled>Apply patch</button>
		</div>
	</div>

	<div id="rom-patcher-powered" class="text-center">
		<a href="https://github.com/marcrobledo/RomPatcher.js" target="_blank"><img
				src="rom-patcher-js/assets/powered_by_rom_patcher_js.png" loading="lazy" />Powered by Rom Patcher JS</a>
	</div>
</body>

</html>
